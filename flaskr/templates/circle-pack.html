<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="static/js/raceChart.js"></script>
    <title>Narrative Viz for CS416</title>
</head>
<body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <div><center><h2>Two Decades of Industry Consolidation</h2></center></div>
    <svg preserveAspectRatio="xMidYMid meet"></svg>

<!-- style section-->
<style></style>

<!-- Code adapted from @Mike Bostock's Race Chart: 
    https://observablehq.com/@d3/bar-chart-race-explained-->
<script type="text/javascript">
    

    //************ Data *******************
    let data = d3.json("static/data/flights2.json")


    const margin = {top: 16, right: 100, bottom: 6, left: 50}
    const width = 900 - margin.left - margin.right
    const height = 500

    let dates = []
    let counts = []
    let carriers = new Set()
    let tickFormat = d3.tickFormat(".0s")
    var formatNumber = d3.format(",d")
    let lastDate = null
    const svg = d3.select("svg")
        .attr("viewBox", [0, 0, width, height]);
    //const updateTicker = setTicker(svg);
    const parseTime = d3.timeParse("%Y %m")    //Str to date
    const formatDate = d3.timeFormat("%Y")  //Date to Str
    const formatDate2 = d3.timeFormat("%b, %Y")  //Date to Str
    const carrierColor = d3.scaleOrdinal(d3.schemePaired)
    var diameter = 600;

    data.then(function(data) {
        data.forEach(function(f){
            let temp = parseTime(f.date)
            dates.push(temp)
            f.date = temp
            counts.push(f.count) 
            carriers.add(f.UniqueCarrier)
        })

        chart()     //Automatically Plays when browser loads
    })

    function pack(data) {
            return d3.pack(data)  
            .size([width - 2, height - 2])
            .padding(3)
    }
    
    function chart() {
        const root = pack(data)

        var bubble = d3.pack(data)
            .size([diameter, diameter])
            .padding(1.5);
        
        var nodes = d3.hierarchy(data)
            .sum(function(d) { return d.count; });
        
        const svg = d3.select("body")
            .append('svg')
            .attr("width", diameter)
            .attr("height", diameter)
            .attr("class", "bubble");
        
        var node = svg.selectAll(".node")
            .data(bubble(nodes).descendants())
            .enter()
            .filter(function(d){
                return  !d.children
            })
            .append("g")
            .attr("class", "node")
            .attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });

        node.append("title")
            .text(function(d) {
                return d.UniqueCarrier;
            });

        node.append("circle")
            .attr("r", function(d) {
                console.log('here at line 100')
                return 5 //d.r; Need to dynamically configure radius length
            })
            .style("fill", function(d,i) {
                console.log('here at line 104')
                return carrierColor(i);
            });

        node.append("text")
            .attr("dy", ".2em")
            .style("text-anchor", "middle")
            .text(function(d) {
                return d.data.UniqueCarrier;
            })
            .attr("font-family", "sans-serif")
            .attr("font-size", function(d){
                return d.r/5;
            })
            .attr("fill", "white");

        node.append("text")
            .attr("dy", "1.3em")
            .style("text-anchor", "middle")
            .text(function(d) {
                return d.data.count;
            })
            .attr("font-family",  "Gill Sans", "Gill Sans MT")
            .attr("font-size", function(d){
                return d.r/5;
            })
            .attr("fill", "white");

        d3.select(self.frameElement)
            .style("height", diameter + "px");
            
        return svg.node();
    }
    


 

</script>
</body>
</html>
